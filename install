#!/usr/bin/env python3
# -*- coding: utf-8 -*-

import os
import argparse
import platform
import shutil
import subprocess

tux_ascii = '''
                 .88888888:.
                88888888.88888.
              .8888888888888888.
              888888888888888888
              88' _`88'_  `88888
              88 88 88 88  88888
              88_88_::_88_:88888
              88:::,::,:::::8888
              88`:::::::::'`8888
             .88  `::::'    8:88.
            8888            `8:888.
          .8888'             `888888.
         .8888:..  .::.  ...:'8888888:.
        .8888.'     :'     `'::`88:88888
       .8888        '         `.888:8888.
      888:8         .           888:88888
    .888:88        .:           888:88888:
    8888888.       ::           88:888888
    `.::.888.      ::          .88888888
   .::::::.888.    ::         :::`8888'.:.
  ::::::::::.888   '         .::::::::::::
  ::::::::::::.8    '      .:8::::::::::::.
 .::::::::::::::.        .:888:::::::::::::
 :::::::::::::::88:.__..:88888:::::::::::'
  `'.:::::::::::88888888888.88:::::::::'
        `':::_:' -- '' -'-' `':_::::'`
'''

apple_ascii = '''
                        .8
                      .888
                    .8888'
                   .8888'
                   888'
                   8'
      .88888888888. .88888888888.
   .8888888888888888888888888888888.
 .8888888888888888888888888888888888.
.&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&'
&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&'
&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&'
@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@:
@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@:
@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@:
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%.
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%.
`%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%.
 `00000000000000000000000000000000000'
  `000000000000000000000000000000000'
   `0000000000000000000000000000000'
     `###########################'
       `#######################'
         `#########''########'
           `""""""'  `"""""'
'''


toplevel = argparse.ArgumentParser()
toplevel.add_argument('--force', action='store_true', help='force install')

subcommands = toplevel.add_subparsers(dest='invoked_command')

cmd_all = subcommands.add_parser('all', help='install all')
cmd_config = subcommands.add_parser('config', help='install config (as symlink)')
cmd_package = subcommands.add_parser('package', help='install packages')
cmd_ocaml = subcommands.add_parser('ocaml', help='install OCaml')
cmd_cargo = subcommands.add_parser('cargo', help='install cargo packages')
cmd_font = subcommands.add_parser('font', help='install fonts')
cmd_emacs = subcommands.add_parser('emacs', help='install emacs settings')


args = toplevel.parse_args()

os_type = platform.system()
if os_type == 'Darwin':
    print(apple_ascii)
elif os_type == 'Linux':
    print(tux_ascii)
else:
    raise NotImplementedError("os type {} is not supported!".format(os_type))

uid = os.geteuid()  # 0 if root


class Installer:
    def __init__(self, manager, packages, sudo=False, yes=False):
        if not shutil.which(manager):
            raise FileNotFoundError('No such executable: {}'.format(manager))

        self.sudo = sudo
        self.yes = yes
        self.manager = manager
        self.packages = packages

    def install(self):
        cmd = ['sudo'] if self.sudo else []
        cmd += [self.manager, 'install']
        cmd += ['--yes'] if self.yes else []
        cmd += self.packages
        subprocess.run(cmd)


apt_packages = ['m4', 'silversearcher-ag', 'tmux', 'tree', 'htop', 'openssh-server',
                'graphviz', 'rsync', 'build-essential', 'tar', 'bzip2', 'gzip', 'zip',
                'autoconf', 'make', 'etckeeper', 'moreutils', 'libmysqlclient-dev']
brew_packages = ['m4', 'tmux', 'bzip2', 'gzip', 'the_silver_searcher', 'htop', 'tree',
                 'emacs-plus@28', '--with-native-comp']
opam_packages = ['merlin', 'tuareg', 'ocamlformat', 'ocp-indent', 'dune', 'base', 'core', 'utop']
cargo_packages = ['dutree', 'loc', 'bat', 'exa', 'eva', 'hyperfine']

# should call os.expanduser() to value
link_info = {
    'nvim': '~/.config/nvim',
    'tmux/conf': '~/.tmux.conf',
    'git/config': '~/.gitconfig',
}
